function loadMapScript(){var i=$(".shop-resources").attr("data-googleapikey").trim(),n="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&callback=initializeMap",t;i&&(n=n+"&key="+i);t=document.createElement("script");t.src=n;document.body.appendChild(t)}function getCustomMapStyles(){var n=$(".shop-resources").attr("data-mapstyles"),t="";if(!n)return"";try{t=JSON.parse(n)}catch(i){console.log("Invalid custom map styles value!")}return t}function initializeMap(){var n=document.getElementById(mapWrapperId),t={center:new google.maps.LatLng(shopX,shopY),zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,styles:getCustomMapStyles()};map=new google.maps.Map(n,t);google.maps.event.addListenerOnce(map,"idle",function(){onMapLoad();createMapSearchBox()})}function onMapLoad(){bounds=new google.maps.LatLngBounds;for(var n=0;n<allShops.length;n++)allShops[n]!=null&&addMarker(allShops[n],!1);allShops.length>1&&map.fitBounds(bounds);directionsService=new google.maps.DirectionsService;directionsDisplay=new google.maps.DirectionsRenderer;directionsDisplay.setPanel(document.getElementById("directions-panel"));$(".getUserGeoLocation").on("click",function(n){n.preventDefault();getUserGeoLocation()})}function addMarker(n,t){var r=new google.maps.LatLng(n.lat,n.lng),i=new google.maps.Marker({position:r,map:map,title:n.title,draggable:t}),u,f;bounds.extend(r);map.setCenter(r);i.setMap(map);markers[n.index]=i;u=$('.shops-list > li[data-ind="'+n.index+'"] .short-description').html()||"";f=new google.maps.InfoWindow({maxWidth:400,content:"<h5>"+n.title+"<\/h5><div>"+u+"<\/div>"});google.maps.event.addListener(i,"click",function(){f.open(map,i);$(".shops-list > li").removeClass("active");$('.shops-list > li[data-ind="'+n.index+'"]').addClass("active")})}function setAllMap(n){for(var t=0;t<markers.length;t++)markers[t]!=null&&markers[t].setMap(n)}function clearMarkers(){setAllMap(null)}function showMarkers(){setAllMap(map)}function deleteMarkers(){clearMarkers();markers=[]}function clearMapRoute(){directionsDisplay.setMap(null);$(".directions-wrapper, .map-wrapper, #backToResults").removeClass("directions-shown")}function createMapSearchBox(){var n=document.getElementById("shop-address-input"),t;map.controls[google.maps.ControlPosition.TOP_LEFT].push(n);t=new google.maps.places.SearchBox(n);n.style.display="block";google.maps.event.addListener(t,"places_changed",function(){var n=t.getPlaces();n.length!=0&&(clearMapRoute(),createUserMarker(n[0].geometry.location),userMarker.setPosition(n[0].geometry.location),map.setCenter(n[0].geometry.location),searchResultCoords=n[0].geometry.location,showDistancesFromShopsToUser())})}function createUserMarker(n){if(!isUserMarkerCreated){var i=$(".shop-resources").attr("data-pathtoimages")+"/squat_marker_green_thumb.png",t=new google.maps.Marker({position:n,map:map,icon:i,animation:google.maps.Animation.DROP,title:$(".shop-resources").attr("data-youarehere"),draggable:!0});t.setMap(map);userMarker=t;bounds.extend(n);$(".distanceAndDirections").show();$('#sortingSelect option[value="sortbydistance"]').removeAttr("disabled");isUserMarkerCreated=!0;google.maps.event.addListener(t,"dragend",function(){showMarkers();$(".shops-list > li").show();showDistancesFromShopsToUser()})}}function getUserGeoLocation(n){var t="Geolocation is not supported by this browser.";return navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(i){if(t="Now we use your current position. ( Maybe a confirmation is required by the browser to use it. )",!isUserMarkerCreated||!n){var r=new google.maps.LatLng(i.coords.latitude,i.coords.longitude);createUserMarker(r);userMarker.setPosition(r);map.setCenter(r)}showDistancesFromShopsToUser();showDirectionsToShop(n)},function(t){if($(".getUserGeoLocation").hide(),$(".additional-info").text("User Geolocation denied. You should enable it from browser permissions settings. Setting the marker to default position..."),!isUserMarkerCreated||!n){var i=new google.maps.LatLng(map.center.lat(),map.center.lng());createUserMarker(i);userMarker.setPosition(i)}showDistancesFromShopsToUser();showDirectionsToShop(n);console.log(t)}),t}function showDirectionsToShop(n){var t,i,r;n&&((t=parseInt(n.closest("li.shops-item").attr("data-ind")),t<0&&markers[t]==null)||(i=$(".shop-resources").attr("data-units")=="Imperial",r={origin:new google.maps.LatLng(userMarker.position.lat(),userMarker.position.lng()),destination:new google.maps.LatLng(markers[t].position.lat(),markers[t].position.lng()),travelMode:google.maps.TravelMode.DRIVING,unitSystem:i?google.maps.UnitSystem.IMPERIAL:google.maps.UnitSystem.METRIC},directionsService.route(r,function(n,t){t==google.maps.DirectionsStatus.OK&&(directionsDisplay.setMap(map),directionsDisplay.setDirections(n),$(".directions-wrapper, .all-shops-page .map-wrapper, #backToResults").addClass("directions-shown"))}),$("html, body").animate({scrollTop:$(".map-wrapper").offset().top-100},500)))}function showDistancesFromShopsToUser(){$(".shops-list > li").each(function(){var n=$(this),t=n.attr("data-ind");markers[t]!=null&&getDistanceToPosition(markers[t].position,n)});$('#sortingSelect option[value="sortbydistance"]').attr("selected","selected");sortShopsByDistance()}function getDistanceToPosition(n,t){var s=$(".shop-resources").attr("data-units")=="Imperial",r=Math.toRadians(userMarker.position.lat()),h=Math.toRadians(userMarker.position.lng()),u=Math.toRadians(n.lat()),c=Math.toRadians(n.lng()),f=u-r,e=c-h,o=Math.sin(f/2)*Math.sin(f/2)+Math.cos(r)*Math.cos(u)*Math.sin(e/2)*Math.sin(e/2),l=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)),i=6371*l;s?(t.find(".distance-value").html(Math.round(i*.621371192)+" mi."),t.find(".distanceToShopValue").val(i*.621371192)):(t.find(".distance-value").html(Math.round(i)+" km."),t.find(".distanceToShopValue").val(i))}function sortShopsBySelectedMethod(){var n=$("#sortingSelect").val();n=="sortbydistance"?sortShopsByDistance():n=="sortbyname"?sortShopsByName():n=="sortbyid"&&sortShopsById()}function sortShopsByName(){var n=$(".shops-list > li");n.sort(function(n,t){var i=$(n).find(".shop-name").text().trim(),r=$(t).find(".shop-name").text().trim();return i.localeCompare(r)});$(".shops-list").html(n)}function sortShopsByDistance(){if(isUserMarkerCreated){var n=$(".shops-list > li");n.sort(function(n,t){var i=parseFloat($(n).find(".distanceToShopValue").val()),r=parseFloat($(t).find(".distanceToShopValue").val());return i-r});$(".shops-list").html(n)}}function sortShopsById(){var n=$(".shops-list > li");n.sort(function(n,t){var i=parseInt($(n).attr("data-ind")),r=parseInt($(t).attr("data-ind"));return i-r});$(".shops-list").html(n)}function searchForShopsMatchingTheSearchCriteria(){var n=isUserMarkerCreated,t=$("#searchByTagsInput").val(),i=t.length>2,r=parseFloat($("#searchRadius").val());(isNaN(r)&&(n=!1),n||i)&&($(".shops-list > li").each(function(){var u=$(this),f=parseInt(u.attr("data-ind")),o=!0,s=!0,h,e;n&&(h=parseFloat(u.find(".distanceToShopValue").val()),h>r&&(o=!1));i&&(e=u.find(".shop-tags-hidden-field").val().toLowerCase(),(e==undefined||e.indexOf(t.toLowerCase())==-1)&&(s=!1));o&&s?(u.show(),markers[f]!=null&&markers[f].setMap(map)):(u.hide(),markers[f]!=null&&markers[f].setMap(null))}),$(".shops-list > li:visible").length==0?$(".no-shops-after-filtering").show():$(".no-shops-after-filtering").hide(),sortShopsBySelectedMethod())}var mapWrapperId="all-shops-map-holder",shopCoordinatesElementClass=".shop-coordinates",allShops=[],directionsService,directionsDisplay,map,markers=[],userMarker,bounds,searchResultCoords,shopX=0,shopY=0,patternCoords=new RegExp(/^-?\d+\.?\d*$/),isUserMarkerCreated=!1;$(document).ready(function(){if($(shopCoordinatesElementClass).length>0&&document.getElementById(mapWrapperId)!=null){$(shopCoordinatesElementClass).each(function(){var n=$(this).attr("data-latitude"),t=$(this).attr("data-longitude");if(n!=null&&t!=null&&patternCoords.test(n)&&patternCoords.test(t)){var i=$(this).closest(".shops-item").attr("data-ind"),r=i!=null?parseInt(i):0,u={index:r,lat:n,lng:t,title:$(this).attr("data-shop-title")};allShops[r]=u}});loadMapScript();$("#backToResults").on("click",function(){clearMapRoute()});$("#searchForFilteredShops").on("click",function(n){n.preventDefault();searchForShopsMatchingTheSearchCriteria();$("#clearShopFilters").css("display","inline-block")});$(".shops-list").on("click",".show-directions",function(n){n.preventDefault();getUserGeoLocation($(this))});$(".shops-list").on("mouseenter","li",function(){var n=markers[$(this).attr("data-ind")];n!=null&&n.setAnimation(google.maps.Animation.BOUNCE)}).on("mouseleave","li",function(){var n=markers[$(this).attr("data-ind")];n!=null&&n.setAnimation(null)});$("#clearShopFilters").on("click",function(){showMarkers();$(".shops-list > li").show();$("#searchByTagsInput").val("");$("#searchRadius").val("");$(this).hide();$(".shops-list > li:visible").length!==0&&$(".no-shops-after-filtering").hide()});$("#sortingSelect").on("change",sortShopsBySelectedMethod);$(".align-map-button").on("click",function(){map.fitBounds(bounds)})}});Math.toRadians=function(n){return n*Math.PI/180};