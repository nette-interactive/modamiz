"use strict";function billingAddressContext(n,t,i,r,u,f,e){function a(n){return r.updateCountry(n,"Billing").then(function(){n=parseInt(n);var i={};return o.settings.stateProvinceEnabled&&(i.states=r.getStatesByCountryId(n)),o.countriesSubjectToVat.indexOf(n)!==-1&&(i.vatNumber=r.checkVatNumber(o.selectedBillingAddress.vat.vatNumber)),t.all(i).then(function(t){if(o.settings.stateProvinceEnabled){o.states=t.states.data;var i,r=o.selectedBillingAddress.stateProvince.value,u=s.getLastState().selectedBillingAddress.stateProvince.value;r!=u?i=r:(i=0,o.selectedBillingAddress.stateProvince={});h("StateProvinceId",i);e(function(){$(document).trigger({type:"addressStatesUpdated",statesDropdownId:"#billingStateProvince"})},100)}return o.countriesSubjectToVat.indexOf(n)!==-1&&(o.selectedBillingAddress.vat.vatNumberStatus=t.vatNumber.data.vatNumberStatus),s.setState(o),t},function(n){return o=s.getLastState(),t.reject(n)})},function(n){return o=s.getLastState(),t.reject(n)})}function v(n){return r.checkVatNumber(n).then(function(n){o.selectedBillingAddress.vat.vatNumberStatus=n.data.vatNumberStatus;s.setState(o)},function(n){return t.reject(n)})}function h(n,i){return r.updateAddress(n,i,"billing").then(function(n){return n},function(n){return t.reject(n)})}function y(n){var i,t,r,f;if(o=n.billingAddresses,o.selectedBillingAddress={},o.selectedBillingAddress.vat={},o.selectedBillingAddress.country={},o.selectedBillingAddress.stateProvince={},o.addresses.length>0){for(i=0;i<o.addresses.length;i++)o.addresses[i].availableCountries=angular.copy(o.availableCountries),o.addresses[i].availableStates=angular.copy(o.availableStatesForNoCountry);t=o.billingAddress;angular.isDefined(t)?(t.availableCountries=angular.copy(o.availableCountries),r=$.grep(o.addresses,function(n){return n.id===t.id}),r.length>0&&(f=r[0],f.availableStates=angular.copy(t.availableStates)),o.selectedBillingAddress=t):(t=angular.copy(o.addresses[0]),o.settings.countryEnabled&&n.configuration.defaultBillingCountryId&&(o.selectedBillingAddress.country.value=n.configuration.defaultBillingCountryId.toString()),t.availableStates=o.availableStates);o.settings.countryEnabled&&(o.countries=t.availableCountries);o.settings.stateProvinceEnabled&&(o.states=t.availableStates);o.selectedBillingAddress.vat.vatNumber=t.vat.vatNumber;o.selectedBillingAddress.vat.vatNumberStatus=t.vat.vatNumberStatus;o.selectedBillingAddress.customAddressAttributes=t.customAddressAttributes;u.equalize(t,o.addresses)}s.setState(o)}function p(){return o}function w(i){var r,e,f,p,c,y,w;if(o&&o.selectedBillingAddress){for(e={},f=angular.copy(o.selectedBillingAddress),angular.isDefined(i.shipToSameAddress)&&(l=i.shipToSameAddress),angular.copy(i.address,o.selectedBillingAddress),i.address.vat.vatNumber!=f.vat.vatNumber&&(e.newVatNumber=i.address.vat.vatNumber,r||(r={}),r.updateVatNumber=v(i.address.vat.vatNumber)),p=0;p<o.persistedBillingAddressFields.length;p++){if(c=o.persistedBillingAddressFields[p],c==="CountryId"&&i.address.country.value!=f.country.value){y=i.address.country.value;y&&y.length!=0||(o.states=angular.copy(i.address.availableStates),y=0);e.newCountryId=y;r||(r={});r.updateCountry=a(y);continue}if(c==="StateProvinceId"&&i.address.stateProvince.value!=f.stateProvince.value){e.newStateProvinceId=i.address.stateProvince.value;r||(r={});r.updateStateProvince=h("StateProvinceId",i.address.stateProvince.value);continue}w=u.uncapitalizeFirstLetter(o.persistedBillingAddressFields[p]);i.address[w]!=f[w]&&(e["new"+c]=i.address[w],r||(r={}),r["update"+c]=h(c,i.address[w]))}angular.isDefined(r)&&n.$broadcast("billingContextChanging",e);t.all(r).then(function(){var t={},e,h,c;for(i.address.vat.vatNumber!=f.vat.vatNumber&&(t.newVatNumber=i.address.vat.vatNumber),e=0;e<o.persistedBillingAddressFields.length;e++){if(h=o.persistedBillingAddressFields[e],h==="CountryId"&&i.address.country.value!=f.country.value){t.newCountryId=i.address.country.value;continue}if(h==="StateProvinceId"&&i.address.stateProvince.value!=f.stateProvince.value){t.newStateProvinceId=i.address.stateProvince.value;continue}c=u.uncapitalizeFirstLetter(o.persistedBillingAddressFields[e]);i.address[c]!=f[c]&&(t["new"+h]=i.address[c])}angular.isDefined(r)&&n.$broadcast("billingContextChanged",t);s.setState(o);n.$broadcast("shipToSameAddress",{currentBillingAddress:o.selectedBillingAddress,shipToSameAddress:i.shipToSameAddress})},function(r){return o.selectedBillingAddress=s.getLastState(),n.$broadcast("billingContextChanged"),n.$broadcast("shipToSameAddress",{currentBillingAddress:o.selectedBillingAddress,shipToSameAddress:i.shipToSameAddress}),t.reject(r)})}}var c={init:y,get:p,set:w},o,l=!1,s=f.instance();return c}angular.module("realOnePageCheckout.billingAddress").factory("billingAddressContext",billingAddressContext);billingAddressContext.$inject=["$rootScope","$q","api","billingAddressService","objectUtility","stateHolder","$timeout"];